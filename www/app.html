<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <!-- Viewport otimizado para mobile: desabilita zoom, usa toda a área, cobre o notch (viewport-fit=cover) -->
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">
    
    <!-- CSP permissiva para desenvolvimento, deve ser restrita em produção -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: gap: content: blob:; worker-src * blob:;">
    
    <title>HyperEngine Mobile</title>
    <script>
        // Anti-FOUC: Injeção Imediata de Tema
        (function() {
            // Força preto inicial para transição suave do Splash Screen
            document.documentElement.style.setProperty('--bg-color', '#000000');
        })();
    </script>
    <script>
        if (!localStorage.getItem("onboard_done")) {
            window.location.replace("onboard.html");
        }

        // Monitoramento de Recursos Críticos (CSS/JS)
        window.addEventListener('error', function(e) {
            if (e.target && (e.target.tagName === 'SCRIPT' || e.target.tagName === 'LINK')) {
                console.error('[CRITICAL] Falha no carregamento:', e.target.src || e.target.href);
                
                // Tratamento visual para falha no bootstrap.js
                if (e.target.src && e.target.src.includes('bootstrap.js')) {
                    const skeleton = document.getElementById('app-skeleton');
                    if (skeleton) {
                        skeleton.innerHTML = `
                            <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; width: 100%; background: #000; color: #fff; z-index: 9999;">
                                <div style="font-size: 48px; margin-bottom: 15px;">⚠️</div>
                                <h3 style="margin-bottom: 10px; color: #FF3B30;">Erro de Inicialização</h3>
                                <p style="color: #8E8E93; margin-bottom: 25px; font-size: 14px;">Não foi possível carregar o sistema.</p>
                                <button onclick="window.location.reload()" style="background: #1C1C1E; color: #fff; border: 1px solid #333; padding: 12px 24px; border-radius: 100px; font-weight: 600; font-size: 14px;">Tentar Novamente</button>
                            </div>
                        `;
                        skeleton.style.opacity = '1';
                    }
                }
            }
        }, true);

    </script>
    
    <!-- Mapbox GL (Essencial para o Mapa) -->
    <script type="module" src="libs/mapbox-gl.js"></script>
    <link href="libs/mapbox-gl.css" rel="stylesheet" />

    <link rel="stylesheet" href="engine.css">
    <link rel="icon" href="data:,">
</head>
<body>
    <div id="dynamic-bg"></div>

    <!-- Skeleton Loader (Tela de Carregamento) -->
    <div id="app-skeleton" class="skeleton-layer">
        <div class="skeleton-header-row">
            <div class="skeleton-circle skeleton-shimmer"></div>
            <div class="skeleton-text-group">
                <div class="skeleton-line short skeleton-shimmer"></div>
                <div class="skeleton-line long skeleton-shimmer"></div>
            </div>
        </div>
        <div class="skeleton-main-card skeleton-shimmer"></div>
        <div class="skeleton-bottom-bar skeleton-shimmer"></div>
    </div>

    <!-- Camada de Renderização Principal (GPU) -->
    <canvas id="gl-canvas"></canvas>

    <!-- Camada de UI / Telemetria (DOM Mínimo) -->
    <div id="ui-layer" class="gpu-layer">
        <div id="telemetry">INITIALIZING KERNEL...</div>

        <!-- Notificação Toast (Feedback de Sucesso) -->
        <div id="toast-notification" class="toast">
            <div class="toast-icon">✓</div>
            <span id="toast-message">Salvo com sucesso</span>
        </div>

        <!-- --- SEÇÕES DO APP --- -->

        <!-- 1. Início (Garagem) -->
        <div id="home-section" class="app-section active">
            <div id="garage-container"></div>
        </div>

        <!-- FAB (Botão Flutuante) -->
        <div id="fab-add-car" class="add-car-fab fab-container" style="display: none;">+</div>

        <!-- 2. Mapa -->
        <div id="map-section" class="app-section">
            <div id="map-container"></div>
            <div id="map-indicators-container"></div>
            
            <div class="map-ui-box">
                <div id="map-loader" class="map-loader">Atualizando...</div>
                <!-- Controles Personalizados do Mapa -->
                <div class="map-custom-controls">
                    <button id="map-compass-btn" class="map-control-btn">
                        <div id="map-compass-icon" style="display: flex; align-items: center; justify-content: center; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);">
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M12 3L16 12H8L12 3Z" fill="#FF3B30" stroke="none"/><path d="M12 21L8 12H16L12 21Z" fill="currentColor" stroke="none"/></svg>
                        </div>
                    </button>
                    <button id="map-zoom-in" class="map-control-btn">＋</button>
                    <button id="map-zoom-out" class="map-control-btn">－</button>
                    <button id="map-locate-me" class="map-control-btn">
                        <img src="img/profile.svg" alt="Localizar">
                    </button>
                </div>

                <div class="map-list-wrapper">
                    <div class="nav-arrow left map-arrow" id="map-prev-btn" style="display: none;">‹</div>
                    <div id="map-car-list" class="map-car-grid"></div>
                    <div class="nav-arrow right map-arrow" id="map-next-btn" style="display: none;">›</div>
                </div>
            </div>
        </div>

        <!-- 3. Alertas -->
        <div id="alerts-section" class="app-section">
            <div class="empty-garage-box" style="border: none; background: transparent;">
                <div class="empty-garage-text">Sem novos alertas.</div>
            </div>
        </div>

        <!-- 4. Configurações -->
        <div id="settings-section" class="app-section">
            <div class="settings-box">
                <div class="settings-container" style="margin-bottom: 15px;">
                    <div class="setting-item">
                        <div class="setting-label-group">
                            <span>Modo Escuro</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="dark-mode-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                    <div class="setting-item vertical">
                        <span>Cor de Destaque</span>
                        <div class="theme-selector">
                            <div class="theme-option" data-theme="theme-blue" style="background: #007AFF;"></div>
                            <div class="theme-option" data-theme="theme-red" style="background: #FF3B30;"></div>
                            <div class="theme-option" data-theme="theme-green" style="background: #34C759;"></div>
                            <div class="theme-option" data-theme="theme-gold" style="background: #FFD700;"></div>
                            <div class="theme-option" data-theme="theme-purple" style="background: #AF52DE;"></div>
                        </div>
                    </div>
                </div>
                <div class="settings-container" style="margin-bottom: 15px;">
                    <div class="setting-item">
                        <div class="setting-label-group">
                            <img src="img/car.svg" alt="Veículos">
                            <span>Veículos</span>
                        </div>
                        <button class="settings-btn"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg></button>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label-group">
                            <img src="img/profile.svg" alt="Conta">
                            <span>Conta</span>
                        </div>
                        <button class="settings-btn"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg></button>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label-group">
                            <img src="img/lock.svg" alt="Segurança">
                            <span>Segurança</span>
                        </div>
                        <button class="settings-btn"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg></button>
                    </div>
                    <div class="setting-item">
                        <div class="setting-label-group">
                            <img src="img/notifications.svg" alt="Notificações">
                            <span>Notificações</span>
                        </div>
                        <label class="switch">
                            <input type="checkbox" id="notifications-toggle">
                            <span class="slider round"></span>
                        </label>
                    </div>
                </div>
                <div class="settings-container" style="margin-bottom: 15px;">
                    <div class="setting-item">
                        <div class="setting-label-group">
                            <img src="img/support.svg" alt="Suporte">
                            <span>Suporte</span>
                        </div>
                        <button class="settings-btn"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg></button>
                    </div>
                </div>
                <div class="settings-container">
                    <div class="setting-item" id="about-app-btn">
                        <span>Sobre o App</span>
                        <span style="color: var(--text-secondary); font-size: 14px;">v1.0.0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Wizard Adicionar Carro (Fase 1) -->
        <div id="add-car-wizard" class="modal-overlay">
            <div class="modal-box">
                <div class="modal-header">
                    <span class="modal-title">Adicionar Veículo</span>
                    <div class="close-modal-btn">×</div>
                </div>
                
                <div class="wizard-progress">
                    <div class="progress-dot active" id="dot-step-1"></div>
                    <div class="progress-dot" id="dot-step-2"></div>
                </div>

                <div class="wizard-container">
                    <div class="wizard-slider" id="wizard-slider">
                        <!-- PASSO 1: DADOS -->
                        <div class="wizard-step active" id="wizard-step-1">
                            <div class="input-group">
                                <input type="text" id="car-brand" class="modal-input" placeholder="Marca" autocomplete="off">
                                <div id="clear-brand" class="clear-input-btn">×</div>
                                <div id="car-brand-suggestions" class="suggestions-list"></div>
                            </div>
                            
                            <div class="input-group">
                                <input type="text" id="car-model" class="modal-input" placeholder="Modelo" disabled autocomplete="off">
                                <div id="model-loader" class="input-loader"></div>
                                <div id="clear-model" class="clear-input-btn">×</div>
                                <div id="car-model-suggestions" class="suggestions-list"></div>
                            </div>

                            <div class="plate-type-container">
                                <div class="plate-type-group">
                                    <label class="radio-label">
                                        <input type="radio" name="plate-type" value="OLD" checked>
                                        <span class="radio-text">ABC-1234</span>
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="plate-type" value="MERCOSUL">
                                        <span class="radio-text">ABC1D23</span>
                                    </label>
                                </div>
                            </div>

                            <div class="input-group">
                                <input type="text" id="car-plate" class="modal-input" placeholder="Placa (Opcional)" maxlength="8" style="text-transform: uppercase;">
                                <div id="clear-plate" class="clear-input-btn">×</div>
                                <span id="plate-counter" class="char-counter">0/8</span>
                            </div>

                            <button id="manual-mode-btn">
                                <img src="img/edit.svg" alt="">
                                <span>Entrada Manual</span>
                            </button>

                            <button id="wizard-next-btn" class="modal-action-btn">
                                <span class="button-text">Continuar</span>
                            </button>
                        </div>

                        <!-- PASSO 2: FOTO E APELIDO -->
                        <div class="wizard-step" id="wizard-step-2">
                            <div class="modal-hint">
                                Personalize seu <span id="summary-brand" style="color:var(--accent-color);font-weight:700;"></span> <span id="summary-model" style="font-weight:700;"></span>
                            </div>

                            <div id="car-photo-container" class="photo-upload-container">
                                <div class="photo-placeholder">
                                    <img src="img/camera.svg" class="camera-icon" alt="">
                                    <span>Adicionar Foto</span>
                                </div>
                                <img id="car-photo-preview" style="display: none;">
                                <input type="file" id="car-photo-input" accept="image/*" hidden>
                            </div>

                            <div class="input-group">
                                <input type="text" id="car-nickname" class="modal-input" placeholder="Apelido (ex: Possante)" maxlength="25">
                                <div id="clear-nickname" class="clear-input-btn">×</div>
                                <span id="nickname-counter" class="char-counter">0/25</span>
                                <div id="nickname-validation" class="input-alert-icon">!</div>
                            </div>

                            <div style="display: flex; gap: 10px;">
                                <button id="wizard-back-btn" class="modal-action-btn" style="background: #333; width: 30%;">
                                    ←
                                </button>
                                <button id="confirm-add-car-btn" class="modal-action-btn" style="width: 70%;">
                                    <span class="button-text">Salvar</span>
                                    <div class="spinner"></div>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Confirmação de Descarte -->
        <div id="confirm-discard-modal" class="modal-overlay" style="z-index: 2100;">
            <div class="modal-box shake-modal">
                <div class="modal-header centered-header">
                    <span class="modal-title">Descartar alterações?</span>
                </div>
                <p class="modal-hint">Os dados inseridos serão perdidos.</p>
                <div class="modal-content" style="flex-direction: row; gap: 10px;">
                    <button id="cancel-discard-btn" class="modal-action-btn" style="background: #333; color: #fff;">Voltar</button>
                    <button id="confirm-discard-btn" class="modal-action-btn danger-btn">Descartar</button>
                </div>
            </div>
        </div>

        <!-- Modal de Recorte (Crop) -->
        <div id="crop-modal" class="modal-overlay" style="z-index: 2200;">
            <div class="modal-box" style="padding: 0; background: #000; height: 100%; width: 100%; border-radius: 0;">
                <div class="crop-viewport">
                    <img id="crop-image" src="">
                </div>
                <div class="crop-controls-panel" style="padding: 20px; background: #1C1C1E; position: absolute; bottom: 0; width: 100%;">
                    <div class="crop-toolbar">
                        <button id="rotate-left-btn" class="tool-btn">↺</button>
                        <button id="rotate-right-btn" class="tool-btn">↻</button>
                        <button id="crop-reset-zoom-btn" class="tool-btn">⤢</button>
                    </div>
                    <div class="crop-controls">
                        <span style="color:#fff; font-size:12px;">Zoom</span>
                        <input type="range" id="crop-zoom-slider" min="0.1" max="3" step="0.1" value="1">
                    </div>
                    <div style="display: flex; gap: 15px; margin-top: 10px;">
                        <button id="cancel-crop-btn" class="modal-action-btn" style="background: #333;">Cancelar</button>
                        <button id="confirm-crop-btn" class="modal-action-btn">Confirmar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Sheet (Fase 3) -->
        <div id="car-action-sheet" class="modal-overlay">
            <div class="action-sheet-panel">
                <div class="action-sheet-item" id="action-locate">
                    <img src="img/location.svg" class="action-sheet-icon" alt="">
                    <span>Localizar no Mapa</span>
                </div>
                <div class="action-sheet-item" id="action-alerts">
                    <img src="img/notifications.svg" class="action-sheet-icon" alt="">
                    <span>Configurar Alertas</span>
                </div>
                <div class="action-sheet-item" id="action-edit">
                    <img src="img/edit.svg" class="action-sheet-icon" alt="">
                    <span>Editar Veículo</span>
                </div>
                <div class="action-sheet-item destructive" id="action-delete">
                    <img src="img/trash.svg" class="action-sheet-icon" alt="">
                    <span>Remover Veículo</span>
                </div>
            </div>
        </div>

        <!-- Painel Inferior Unificado (Bottom Panel) -->
        <div id="bottom-panel">
            <div class="widgets-row">
                <div class="widget active" data-target="home-section">
                    <div class="widget-icon-box"><img src="img/home.svg" alt="Início"></div>
                    <div class="widget-label">Início</div>
                </div>
                <div class="widget" data-target="map-section">
                    <div class="widget-icon-box"><img src="img/location.svg" alt="Mapa"></div>
                    <div class="widget-label">Mapa</div>
                </div>
                <div class="widget" data-target="alerts-section">
                    <div class="widget-icon-box"><img src="img/notifications.svg" alt="Alertas"></div>
                    <div class="widget-label">Alertas</div>
                </div>
                <div class="widget" data-target="settings-section">
                    <div class="widget-icon-box"><img src="img/settings.svg" alt="Configurações"></div>
                    <div class="widget-label">Ajustes</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module" src="bootstrap.js"></script>
</body>
</html>