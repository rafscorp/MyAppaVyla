<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, viewport-fit=cover">
    <title>Bem-vindo</title>
    <style>
        /* --- DESIGN SYSTEM PREMIUM --- */
        :root {
            --primary: #007AFF;
            --bg: #000000;
            --text: #FFFFFF;
            --text-secondary: #8E8E93;
            --surface: #1C1C1E;
        }
        
        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            color: var(--text);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* --- SLIDER COM SCROLL SNAP (Nativo & Fluido) --- */
        .onboard-slider {
            flex: 75; /* Ocupa 75% da altura */
            display: flex;
            overflow-x: auto;
            overflow-y: hidden;
            scroll-snap-type: x mandatory; /* A mágica do snap nativo */
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        
        .onboard-slider::-webkit-scrollbar {
            display: none; /* Chrome/Safari */
        }

        /* Slide Individual */
        .slide {
            min-width: 100%;
            height: 100%;
            scroll-snap-align: center; /* Ponto de paragem */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            box-sizing: border-box;
            text-align: center;
        }

        /* Conteúdo Visual */
        .slide-image {
            width: 80%;
            max-width: 280px;
            height: auto;
            margin-bottom: 40px;
            /* Sombra suave para profundidade */
            filter: drop-shadow(0 10px 20px rgba(0,122,255,0.15));
            /* Filtro para colorir os SVGs pretos para o tema */
            transition: transform 0.5s ease;
        }

        .slide h1 {
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 16px 0;
            line-height: 1.2;
            /* Gradiente sutil no texto */
            background: linear-gradient(135deg, #fff 0%, #a5a5a5 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .slide p {
            font-size: 17px;
            line-height: 1.5;
            color: var(--text-secondary);
            margin: 0;
            max-width: 300px;
        }

        /* --- ÁREA DE CONTROLO (Bottom 30%) --- */
        .controls-area {
            flex: 25; /* 25% da altura */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px 40px 50px;
            /* Gradiente para suavizar a transição do fundo */
            background: linear-gradient(to top, rgba(0,0,0,1) 20%, rgba(0,0,0,0));
            z-index: 10;
        }

        /* Indicadores (Dots) */
        .dots-container {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
        }

        .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: rgba(255,255,255,0.2);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .dot.active {
            width: 24px; /* Estica a bolinha ativa */
            background-color: var(--primary);
            border-radius: 4px;
        }

        /* Botão de Ação Principal */
        .action-btn {
            width: 100%;
            height: 56px;
            border-radius: 28px;
            border: none;
            background: var(--surface);
            color: var(--text);
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .action-btn:active {
            transform: scale(0.96);
        }

        /* Estado Call to Action (Slide Final) */
        .action-btn.primary {
            background: var(--primary);
            color: #fff;
            box-shadow: 0 8px 24px rgba(0, 122, 255, 0.4);
        }

        /* Estado de Carregamento/Espera */
        .action-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <!-- Slider Container -->
    <div class="onboard-slider" id="slider">
        <!-- Slide 1: Bem-vindo -->
        <div class="slide">
            <!-- Ícone Carro -->
            <img src="img/car.svg" class="slide-image" style="filter: invert(34%) sepia(98%) saturate(2362%) hue-rotate(201deg) brightness(101%) contrast(105%);">
            <h1>Bem-vindo ao<br>MyAppaVyla</h1>
            <p>O controlo total do seu veículo. Vamos configurar o seu dispositivo em poucos passos.</p>
        </div>

        <!-- Slide 2: Localização -->
        <div class="slide">
            <img src="img/location.svg" class="slide-image" style="filter: invert(34%) sepia(98%) saturate(2362%) hue-rotate(201deg) brightness(101%) contrast(105%);">
            <h1>Rastreio Exato</h1>
            <p>Precisamos de acesso à sua localização para mostrar a distância entre si e os seus veículos.</p>
        </div>

        <!-- Slide 3: Notificações -->
        <div class="slide">
            <!-- Ícone Sino (Filtro verde para sucesso/finalização) -->
            <img src="img/notifications.svg" class="slide-image" style="filter: invert(66%) sepia(50%) saturate(5463%) hue-rotate(93deg) brightness(98%) contrast(92%);">
            <h1>Mantenha-se Alerta</h1>
            <p>Ative as notificações para receber avisos de movimento ou ignição ligada.</p>
        </div>
    </div>

    <!-- Controls Area -->
    <div class="controls-area">
        <div class="dots-container">
            <div class="dot active"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
        <button id="action-btn" class="action-btn">Começar</button>
    </div>

    <script>
        // --- ESTADO DO DISPOSITIVO ---
        let isDeviceReady = false;
        document.addEventListener('deviceready', () => {
            isDeviceReady = true;
            console.log("[Onboard] Device Ready - Permissões Nativas Ativas");
        }, false);

        // --- LÓGICA DE INTERAÇÃO ---
        const slider = document.getElementById('slider');
        const btn = document.getElementById('action-btn');
        const dots = document.querySelectorAll('.dot');
        let currentIndex = 0;
        const totalSlides = 3;

        // Helper de Vibração (Haptics)
        const vibrate = (pattern) => {
            if (navigator.vibrate) navigator.vibrate(pattern);
        };

        // Helper de Permissões (Abstração Robusta e Visual)
        const requestNativePermission = (permissionName, successText, errorText) => {
            return new Promise((resolve) => {
                // Timeout de Segurança (3s) - Impede bloqueio se o plugin falhar
                const safetyTimer = setTimeout(() => {
                    console.warn(`[Onboard] Timeout de segurança: ${permissionName}`);
                    btn.textContent = "Avançar"; 
                    resolve(false);
                }, 3000);

                // Fallback para Browser (Desenvolvimento)
                if (!isDeviceReady || !window.cordova) {
                    console.log(`[DEV] Permissão simulada: ${permissionName}`);
                    clearTimeout(safetyTimer);
                    setTimeout(() => {
                        btn.textContent = successText;
                        btn.style.backgroundColor = "#34C759"; // Verde
                        resolve(true);
                    }, 500);
                    return;
                }

                const permissions = window.cordova.plugins.permissions;

                // Solicita permissão diretamente (Sem lógica complexa)
                permissions.requestPermission(
                    permissionName,
                    (status) => {
                        clearTimeout(safetyTimer);
                        if (status && status.hasPermission) {
                            btn.textContent = successText;
                            btn.style.backgroundColor = "#34C759"; // Verde
                            resolve(true);
                        } else {
                            btn.textContent = errorText;
                            btn.style.backgroundColor = "#FF3B30"; // Vermelho
                            resolve(false);
                        }
                    },
                    (error) => {
                        clearTimeout(safetyTimer);
                        console.warn(`[Onboard] Erro plugin: ${error}`);
                        btn.textContent = "Erro (Avançar)";
                        resolve(false);
                    }
                );
            });
        };

        // Atualiza UI baseada na posição do scroll
        const updateUI = () => {
            const width = slider.clientWidth;
            const scrollPos = slider.scrollLeft;
            // Calcula o índice atual baseado no scroll
            const newIndex = Math.round(scrollPos / width);

            if (newIndex !== currentIndex) {
                currentIndex = newIndex;
                vibrate(10); // Feedback tátil leve ao trocar de slide

                // Limpa estilos inline (cores de sucesso/erro) ao mudar de slide
                btn.style.backgroundColor = "";
                btn.disabled = false;

                // Sincroniza Dots
                dots.forEach((dot, i) => {
                    if (i === currentIndex) dot.classList.add('active');
                    else dot.classList.remove('active');
                });

                // Máquina de Estados do Botão
                if (currentIndex === 0) {
                    btn.textContent = "Começar";
                    btn.classList.remove('primary');
                } else if (currentIndex === 1) {
                    btn.textContent = "Permitir Localização";
                    btn.classList.add('primary');
                } else if (currentIndex === 2) {
                    btn.textContent = "Permitir Notificações";
                    btn.classList.add('primary');
                }
            }
        };

        // Função de Scroll Seguro
        const scrollToSlide = (index) => {
            slider.scrollTo({
                left: slider.clientWidth * index,
                behavior: 'smooth'
            });
        };

        // Ouve o evento de scroll (nativo e performático)
        slider.addEventListener('scroll', updateUI, { passive: true });

        // Lógica Principal do Botão
        btn.addEventListener('click', async () => {
            vibrate(10);

            if (currentIndex === 0) {
                // Slide 1 -> 2
                scrollToSlide(1);
            } 
            else if (currentIndex === 1) {
                // Slide 2 -> Pedir Localização
                btn.disabled = true;
                btn.textContent = "Aguardando...";
                
                // Usa a constante do plugin se disponível, ou string direta
                const perm = window.cordova?.plugins?.permissions?.ACCESS_FINE_LOCATION || 'android.permission.ACCESS_FINE_LOCATION';
                
                await requestNativePermission(perm, "✓ Localização Aceite", "✕ Localização Negada");
                
                // Delay visual para leitura
                setTimeout(() => {
                    scrollToSlide(2);
                }, 1000);
            } 
            else if (currentIndex === 2) {
                // Slide 3 -> Pedir Notificações
                btn.disabled = true;
                btn.textContent = "Aguardando...";

                // Permissão Android 13+ (POST_NOTIFICATIONS)
                const perm = 'android.permission.POST_NOTIFICATIONS';

                await requestNativePermission(perm, "✓ Notificações Ativas", "✕ Notificações Negadas");

                // Finaliza Onboarding
                setTimeout(() => {
                    vibrate([10, 50, 10]); 
                    localStorage.setItem('onboard_done', 'true');
                    window.location.replace('app.html');
                }, 1000);
            }
        });
    </script>
</body>
</html>